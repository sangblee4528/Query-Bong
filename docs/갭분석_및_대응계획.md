# 📄 갭 분석 및 대응 계획 (Gap Analysis & Action Plan)

## 1. 개요
본 문서는 `docs/설계서.md`의 설계 내용과 현재 구현된 프로젝트(`engine/`, `data/` 등) 간의 차이점을 분석하고, 이를 설계 사양에 맞춰 일치시키기 위한 대응 계획을 기술합니다.

## 2. 주요 차이점 (Differences)

| 구분 | 설계 (Design) | 현재 구현 (Current Implementation) | 차이점 및 리스크 |
| :--- | :--- | :--- | :--- |
| **분석 엔진** | **`sqlglot` 기반 AST 분석** | `sqlparse` (Regex/Token 기반) | `sqlparse`는 복잡한 서브쿼리나 중첩 구조에서 정확한 영역(`Fixed`/`Change`) 분류가 어려움. 설계의 "정밀도" 요건 미충족. |
| **운영 프로세스** | **Inbox → Success/Failed 격리 운영** | 단일 `data/source` 폴더 조회 | 분석 실패 시 파일이 격리되지 않아 반복적인 오류 발생 가능성 및 운영 가시성 부족. |
| **데이터 관리** | **Move-then-Insert (History 보관)** | `INSERT OR REPLACE` (덮어쓰기) | 쿼리 수정 이력이 남지 않으며, 동일 쿼리 재등록 시 과거 데이터가 유실됨. |
| **DB 스키마** | `TB_QUERY_ASSET`, `TB_QUERY_HISTORY` | `queries` 단일 테이블 | 설계된 이력 관리 및 정규화된 자산 관리 체계(`TB_` 명명규칙 포함)와 불일치. |
| **디렉토리 구조** | `/source/inbox`, `/output/json` | `data/source`, `data/templates` | 폴더 구조가 설계와 상이하여 운영 스크립트(`Move`) 구현 시 혼선 발생. |

## 3. 대응 계획 (Action Plan)

설계 문서(`설계서.md`)를 기준(Source of Truth)으로 삼아 프로젝트를 리팩토링합니다.

### Phase 1: 기반 구조 및 라이브러리 정비
*   **디렉토리 재구성:** `data/source` 하위에 `inbox`, `success`, `failed` 구조 생성.
*   **환경 설정(`config.json`) 업데이트:** 변경된 경로 반영.
*   **라이브러리 추가:** `requirements.txt`에 `sqlglot` 추가 및 설치.

### Phase 2: DB 스키마 일치화
*   **테이블 리팩토링:** `load_json_data.py`를 수정하여 `TB_QUERY_ASSET`, `TB_QUERY_HISTORY` 테이블 생성 로직 구현.
*   **이력 관리 로직:** 덮어쓰기 로직을 'Move(Insert History -> Delete Current) then Insert' 구조로 변경.

### Phase 3: 분석 엔진 고도화 (`sql_analyzer.py`)
*   **엔진 교체:** `sqlparse` 로직을 제거하고 `sqlglot` 기반의 `Optimizer` 및 `Expression` 탐색 로직으로 전면 재작성.
*   **영역 분류 구현:** `FROM` 절 서브쿼리(`Fixed`), `WHERE` 절 조건(`Change`) 자동 분류 알고리즘 적용.
*   **재귀 분석:** 중첩된 쿼리 구조를 재귀적으로 탐색하는 로직 추가.

## 4. 수행 결과물
*   수정된 `engine/sql_analyzer.py` (AST 기반)
*   수정된 `engine/load_json_data.py` (History 관리 포함)
*   재구성된 `data/` 디렉토리 구조
*   업데이트된 `requirements.txt`
